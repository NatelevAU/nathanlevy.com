name: Main Branch Workflow
on:
  push:
    branches:
      - main
    paths:
      - 'src/**/*'
      - 'public/**/*'
      - 'package.json'
      - 'package-lock.json'
      - '.eslintignore'
      - '.eslintrc.js'
      - '.github/workflows/*.yml'
      - '.prettierignore'
      - '.prettierrc'

env:
  APP_NAME: 'NatelevAU'
  DEPLOY_HOSTNAME: 'nathanlevy.com'
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

# Jobs for install_dependencies, lint, and tests are the same as in the default branch workflow

jobs:
  # ... (install_dependencies, lint, tests)

  build:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      # ... (Checkout code, Setup Node.js, Cache node modules)
      - name: Build application
        run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v2
        with:
          name: build
          path: build/

  deploy_prod:
    needs: build
    runs-on: ubuntu-latest
    steps:
      # ... (SSH setup)
      - name: Download build artifacts
        uses: actions/download-artifact@v2
        with:
          name: build
          path: build/
      - name: Set up environment variables
        run: |
          echo "RELEASE_BASE=/var/www/dev-${{ env.APP_NAME }}" >> $GITHUB_ENV
          echo "RELEASE_PATH=/var/www/dev-${{ env.APP_NAME }}/releases/${{ github.sha }}" >> $GITHUB_ENV
      - name: Deploy to production
        run: |
          rsync -rav --delete build/ deploy@${{ env.DEPLOY_HOSTNAME }}:${{ env.RELEASE_PATH }}
          ssh deploy@${{ env.DEPLOY_HOSTNAME }} "ln -nfs ${{ env.RELEASE_PATH }} ${{ env.RELEASE_BASE }}/current"

  cleanup_releases:
    needs: deploy_prod
    runs-on: ubuntu-latest
    steps:
      # ... (SSH setup)
      - name: Cleanup releases
        run: |
          RELEASE_BASE="/var/www/${{ env.APP_NAME }}"
          ssh deploy@${{ env.DEPLOY_HOSTNAME }} "ls -t ${{ env.RELEASE_BASE }}/releases | tail -n +6 | xargs -I {} rm -rf ${{ env.RELEASE_BASE }}/releases/{}"

  reverse_deploy_prod:
    needs: deploy_prod
    runs-on: ubuntu-latest
    steps:
      # ... (SSH setup)
      - name: Reverse deploy
        run: |
          RELEASE_BASE="/var/www/${{ env.APP_NAME }}"
          SECOND_LAST_RELEASE=$(ssh deploy@${{ env.DEPLOY_HOSTNAME }} "ls -t ${{ env.RELEASE_BASE }}/releases | sed -n '2p'")
          ssh deploy@${{ env.DEPLOY_HOSTNAME }} "ln -nfs ${{ env.RELEASE_BASE }}/releases/${SECOND_LAST_RELEASE} ${{ env.RELEASE_BASE }}/current"
